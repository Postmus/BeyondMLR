---
title: "Assignment 6: Cardiac Recovery Analysis"
subtitle: "Model answer (Example: QoL ~ Diabetes × Time, moderated by Rehab Program)"
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: right
    code-overflow: wrap
execute:
  warning: false
  message: false
  eval: true
  echo: true
---

::: {.callout-note icon=false title="Preliminary setup"}
```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(dplyr, ggplot2, lmerTest, emmeans)
```
:::

# Example Analysis

This model answer demonstrates the analysis for **Question ID 4**:

- **Outcome**: Quality of Life (0-100)
- **Main predictor**: Diabetes status
- **Research question**: Does diabetes affect QoL recovery, and does the rehab program moderate recovery trajectories?

## Generate the Example Dataset

```{r}
# Simulate the same process students would use
student_id <- 999904  # Example ID that maps to question 4

master_data <- read.csv("downloads/cardiac_recovery_master.csv")
lookup_table <- read.csv("downloads/research_questions_lookup.csv")

set.seed(student_id)
question_id <- ((student_id - 1) %% 9) + 1
my_question <- lookup_table[question_id, ]

# Sample 60% of patients
sampled_patients <- sample(unique(master_data$patient_id),
                            size = round(0.6 * length(unique(master_data$patient_id))))

my_data <- master_data %>%
  filter(patient_id %in% sampled_patients)

# Show assignment details
cat("Outcome:", my_question$outcome_label, "\n")
cat("Main predictor:", my_question$predictor_label, "\n")
cat("N patients:", n_distinct(my_data$patient_id), "\n")
cat("N observations:", nrow(my_data), "\n")
```

## Exploratory Data Analysis

### Data Structure

```{r}
# Convert categorical variables to factors
my_data <- my_data %>%
  mutate(
    diabetes = factor(diabetes),
    sex = factor(sex),
    surgery_type = factor(surgery_type),
    rehab_program = factor(rehab_program),
    visit = factor(visit, levels = c("Baseline", "2 weeks", "6 weeks", "3 months", "6 months"))
  )

str(my_data)
```

```{r}
# Sample sizes
cat("Patients by diabetes status:\n")
my_data %>% distinct(patient_id, diabetes) %>% count(diabetes)

cat("\nPatients by rehab program:\n")
my_data %>% distinct(patient_id, rehab_program) %>% count(rehab_program)
```

### Distribution of Outcome

```{r}
ggplot(my_data, aes(x = quality_of_life)) +
  geom_histogram(bins = 25, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Quality of Life Scores",
       x = "Quality of Life (0-100)", y = "Frequency") +
  theme_minimal()
```

```{r}
# By time point
ggplot(my_data, aes(x = visit, y = quality_of_life)) +
  geom_boxplot(fill = "skyblue", alpha = 0.7) +
  labs(title = "Quality of Life by Visit",
       x = "Visit", y = "Quality of Life") +
  theme_minimal()
```

### Spaghetti Plots

```{r}
# Overall trajectories (sample of 50 patients for clarity)
set.seed(42)
sample_patients <- sample(unique(my_data$patient_id), 50)

my_data %>%
  filter(patient_id %in% sample_patients) %>%
  ggplot(aes(x = time_months, y = quality_of_life, group = patient_id)) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.3, size = 1) +
  labs(title = "Individual Recovery Trajectories (n = 50 patients)",
       x = "Months since surgery", y = "Quality of Life") +
  theme_minimal()
```

```{r}
# By diabetes status
my_data %>%
  filter(patient_id %in% sample_patients) %>%
  ggplot(aes(x = time_months, y = quality_of_life, group = patient_id, color = diabetes)) +
  geom_line(alpha = 0.4) +
  facet_wrap(~diabetes) +
  labs(title = "Recovery Trajectories by Diabetes Status",
       x = "Months since surgery", y = "Quality of Life") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Mean trajectories by diabetes and rehab program
mean_trajectories <- my_data %>%
  group_by(diabetes, rehab_program, time_months) %>%
  summarise(mean_qol = mean(quality_of_life, na.rm = TRUE), .groups = "drop")

ggplot(mean_trajectories, aes(x = time_months, y = mean_qol,
                               color = diabetes, linetype = rehab_program)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(title = "Mean Recovery Trajectories",
       subtitle = "By diabetes status and rehabilitation program",
       x = "Months since surgery", y = "Mean Quality of Life",
       color = "Diabetes", linetype = "Rehab Program") +
  theme_minimal()
```

The EDA suggests:

1. QoL improves over time
2. Patients with diabetes may have lower QoL overall
3. Enhanced rehab may be associated with faster recovery

## Growth Curve Modeling

### Model 1: Null Model

We start with a null model to calculate the ICC - how much variance is between patients vs. within patients over time:

```{r}
# Null model with random intercepts for patients
model_null <- lmer(quality_of_life ~ 1 + (1 | patient_id), data = my_data)
summary(model_null)
```

```{r}
# Calculate ICC
var_components <- as.data.frame(VarCorr(model_null))
var_between <- var_components$vcov[1]  # Between-patient variance
var_within <- var_components$vcov[2]   # Within-patient (residual) variance

ICC <- var_between / (var_between + var_within)
cat("Between-patient variance:", round(var_between, 2), "\n")
cat("Within-patient variance:", round(var_within, 2), "\n")
cat("ICC:", round(ICC, 3), "\n")
```

The ICC indicates that a substantial proportion of the variability in QoL is due to stable differences between patients, while the rest is due to within-patient variation over time. This confirms the need for a multilevel approach.

### Model 2: Linear Growth with Random Slopes

We add time as a fixed effect and allow patients to have different growth rates:

```{r}
# Growth model with random intercepts and slopes
model_growth <- lmer(quality_of_life ~ time_months + (time_months | patient_id),
                     data = my_data)
summary(model_growth)
```

```{r}
# Compare to null model
anova(model_null, model_growth)
```

The growth model significantly improves fit. Let's examine the random effects:

```{r}
var_comp <- as.data.frame(VarCorr(model_growth))
cat("Random intercept SD:", round(var_comp$sdcor[1], 2), "\n")
cat("Random slope SD:", round(var_comp$sdcor[2], 2), "\n")
cat("Intercept-slope correlation:", round(var_comp$sdcor[3], 2), "\n")
```

### Model 3: Add Diabetes (Main Predictor)

```{r}
# Use effects coding for easier interpretation
options(contrasts = c("contr.sum", "contr.poly"))

# Main effect and interaction with time
model_diabetes <- lmer(quality_of_life ~ time_months * diabetes +
                         (time_months | patient_id),
                       data = my_data)
summary(model_diabetes)
```

```{r}
# Test significance of diabetes effects
anova(model_growth, model_diabetes)
```

### Model 4: Add Rehab Program with Interaction

```{r}
# Full model
model_full <- lmer(quality_of_life ~ time_months * diabetes +
                     time_months * rehab_program +
                     (time_months | patient_id),
                   data = my_data)
summary(model_full)
```

```{r}
# Compare models
anova(model_diabetes, model_full)
```

```{r}
# Model comparison summary
cat("Model Comparison (AIC):\n")
cat("  Null model:", round(AIC(model_null), 1), "\n")
cat("  Growth model:", round(AIC(model_growth), 1), "\n")
cat("  + Diabetes:", round(AIC(model_diabetes), 1), "\n")
cat("  + Rehab program:", round(AIC(model_full), 1), "\n")
```

## Model Diagnostics

```{r}
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(model_full), residuals(model_full),
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, lty = 2, col = "red")

# Q-Q plot of residuals
qqnorm(residuals(model_full), main = "Q-Q Plot (Residuals)")
qqline(residuals(model_full), col = "red")

# Histogram of residuals
hist(residuals(model_full), breaks = 30, main = "Histogram of Residuals",
     xlab = "Residuals", col = "skyblue")

# Q-Q plot of random intercepts
ranef_int <- ranef(model_full)$patient_id[, "(Intercept)"]
qqnorm(ranef_int, main = "Q-Q Plot (Random Intercepts)")
qqline(ranef_int, col = "red")
```

The diagnostic plots show reasonable adherence to model assumptions.

## Visualization of Results

```{r}
# Create prediction data
pred_grid <- expand.grid(
  time_months = seq(0, 6, by = 0.5),
  diabetes = levels(my_data$diabetes),
  rehab_program = levels(my_data$rehab_program)
)

# Get predictions (fixed effects only)
pred_grid$predicted <- predict(model_full, newdata = pred_grid, re.form = NA)

# Plot
ggplot(pred_grid, aes(x = time_months, y = predicted,
                       color = diabetes, linetype = rehab_program)) +
  geom_line(linewidth = 1.2) +
  labs(title = "Predicted Recovery Trajectories",
       subtitle = "From final model: QoL ~ Time × Diabetes + Time × Rehab Program",
       x = "Months since surgery",
       y = "Predicted Quality of Life",
       color = "Diabetes",
       linetype = "Rehab Program") +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r}
# Faceted version for clarity
ggplot(pred_grid, aes(x = time_months, y = predicted, color = diabetes)) +
  geom_line(linewidth = 1.2) +
  facet_wrap(~rehab_program) +
  labs(title = "Predicted Recovery Trajectories by Rehab Program",
       x = "Months since surgery",
       y = "Predicted Quality of Life",
       color = "Diabetes") +
  theme_minimal()
```

## Interpretation of Results

### Fixed Effects

```{r}
# Extract and interpret fixed effects
coefs <- fixef(model_full)
print(round(coefs, 3))
```

With effects coding:

- **Intercept**: The grand mean QoL at baseline (time = 0), averaging across diabetes status and rehab program
- **time_months**: Average improvement in QoL per month
- **diabetes1**: How much patients without diabetes differ from the grand mean
- **rehab_program1**: Effect of Enhanced rehab relative to grand mean
- **Interactions**: How recovery rates differ by group

### Estimated Marginal Means

```{r}
# Estimated means at 6 months by group
emmeans(model_full, ~ diabetes * rehab_program, at = list(time_months = 6))
```

```{r}
# Recovery rates by group
emtrends(model_full, ~ diabetes * rehab_program, var = "time_months")
```

## Summary and Conclusions

### Key Findings

1. **Overall recovery pattern**: Quality of life improves significantly over the 6-month follow-up period.

2. **Effect of diabetes**: Patients with diabetes have lower QoL scores compared to those without diabetes.

3. **Effect of rehabilitation program**: The enhanced rehabilitation program is associated with better outcomes and may accelerate recovery.

4. **Random effects**: There is substantial variability between patients in both their baseline QoL and their recovery rates.

### Clinical Implications

- Patients with diabetes may benefit from additional support during cardiac recovery
- Enhanced rehabilitation programs appear to improve outcomes
- Individual variability highlights the importance of personalized care

### Limitations

1. **Simulated data**: This is simulated data for educational purposes
2. **Missing confounders**: Other factors may influence recovery
3. **Linear time assumption**: Recovery patterns may be non-linear
