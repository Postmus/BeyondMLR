---
title: "Assignment 3: Multilevel Modeling"
format: 
  html:
    toc: true       # Enable the table of contents
    toc-depth: 3    # Set the depth of headers included in the ToC (e.g., H1, H2, H3)
    toc-location: right   # Optional: Can be left, right, or floating    
    code-overflow: wrap 
---

```{r}
#| label: setup
#| include: false

# configure global options for R code chunks:
# warning = F to suppress the display of warning messages generated during the execution of code chunks
# message = F to suppress the display of messages produced during the execution of code chunks
knitr::opts_chunk$set(warning = FALSE, message = FALSE, eval = TRUE)

# This qmd file requires the following packages to be installed:
#c("dplyr", "ggplot2", "emmeans", "lme4", "lmerTest")
```

## Exploratory Data Analysis

Let's load the data and use the `str()` function to inspect the structure of the dataset.

```{r}
# Load the required libraries
library(dplyr)
library(ggplot2)
library(lmerTest)

ilea_data <- read.csv("Assignments/Week 3/downloads/ilea_data.csv")

# Convert all character variables into factors
ilea_data <- ilea_data %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate(School = as.factor(School))

# Inspect the structure of the dataset
str(ilea_data)
```

We start by creating a histogram to visualize the distribution of the outcome variable `ExamScore`:

```{r}
# Create a histogram of exam scores
ggplot(ilea_data, aes(x = ExamScore)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "black", alpha = 0.7) +
  geom_vline(xintercept = mean(ilea_data$ExamScore), linetype = "dashed", color = "red") +
  labs(title = "Distribution of Exam Scores",
       x = "Exam Score",
       y = "Frequency") +
  theme_minimal()
```

We also want to get a sense of the variability in exam scores within and between schools. For this, we randomly select 15 schools and create a scatter plot showing individual student scores and school means:

```{r}
# Set seed for reproducibility
set.seed(123)

# Randomly select 15 unique schools
random_schools <- sample(unique(ilea_data$School), size = 15)

# Filter the data to include only the randomly selected schools
random_school_data <- ilea_data |>
  filter(School %in% random_schools)

# Calculate the average ExamScore for each school
school_avg_score <- random_school_data |>
  group_by(School) |>
  summarise(avg_exam_score = mean(ExamScore, na.rm = TRUE), .groups = "drop")

# Calculate the overall grand mean across all schools
grand_mean <- mean(ilea_data$ExamScore, na.rm = TRUE)

# Create scatter plot with jittered observations
ggplot(random_school_data, aes(x = reorder(School, ExamScore, FUN = mean), y = ExamScore)) +
  geom_hline(yintercept = grand_mean, linetype = "solid", color = "black", linewidth = 1) +
  geom_jitter(alpha = 0.3, width = 0.2, size = 1, color = "gray60") +
  geom_point(data = school_avg_score, aes(x = reorder(School, avg_exam_score), y = avg_exam_score),
             size = 4, shape = 18, color = "red") +
  labs(title = "Variation in exam scores: within and between schools",
       subtitle = "Points = individual students; Diamonds = school means; Solid line = grand mean (all data)",
       x = "School (ordered by mean exam score)",
       y = "Exam Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Random intercept model 

```{r}
# Fit the random intercept model
random_intercept_model <- lmer(ExamScore ~ 1 + (1 | School), data = ilea_data)
summary(random_intercept_model)
```

## Extending the random intercept model with subject-level variables

```{r}
# Use effects coding for the categorical variables
options(contrasts = c("contr.sum", "contr.poly"))
```

Next, we fit the random intercept model with the subject-level variables included:

```{r}
# Fit the random intercept model with subject-level variables    
random_intercept_model_L1variables <- lmer(ExamScore ~ Gender + VRBand + (1 | School), data = ilea_data)
summary(random_intercept_model_L1variables)

contrasts(ilea_data$Gender)
contrasts(ilea_data$VRBand)

# Obtain the ANOVA table for the subject-level variables
anova(random_intercept_model_L1variables)
```

## Including context-level variables

As a third step, we extend the previously fitted model with context-level variables. We start by centering the context-level variables:

```{r}
# Center the context-level variables
ilea_data <- ilea_data %>%
  mutate(PercentFSM_c = scale(PercentFSM, scale = FALSE))
```

Next, we fit the random intercept model with both subject-level and context-level variables included:

```{r}
# Fit the random intercept model with subject-level and context-level variables
random_intercept_model_L1L2variables <- lmer(ExamScore ~PercentFSM_c + (1 | School), data = ilea_data)
summary(random_intercept_model_L1L2variables)

# Obtain the ANOVA table
anova(random_intercept_model_L1L2variables)  
```

## Exploring cross-level interactions

Finally, we explore the possibility of cross-level interactions between individual-level and context-level variables.

```{r}
# Fit the model with the interaction between PercentFSM_c and Gender
random_intercept_model_interaction1 <- lmer(ExamScore ~ PercentFSM_c*Gender + (1 | School), data = ilea_data)
summary(random_intercept_model_interaction1)

# Fit the model with the interaction between PercentFSM_c and VRBand
random_intercept_model_interaction2 <- lmer(ExamScore ~ PercentFSM_c*VRBand + (1 | School), data = ilea_data)
summary(random_intercept_model_interaction2)
```

## Model diagnostics: checking residuals

To assess whether the model assumptions are satisfied, we examine the conditional residuals. We'll create diagnostic plots to check for normality and homoscedasticity.

```{r}
# Fit a more complete model including both individual and school-level variables
model_full <- lmer(ExamScore ~ Gender + VRBand + PercentFSM_c + (1 | School), data = ilea_data)

# Extract conditional residuals from the full model
ilea_data <- ilea_data %>%
  mutate(residuals = residuals(model_full),
         fitted = fitted(model_full))

# Create a Q-Q plot to assess normality of residuals
ggplot(ilea_data, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q Plot of Conditional Residuals",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

# Create a residuals vs fitted plot to assess homoscedasticity
ggplot(ilea_data, aes(x = fitted, y = residuals)) +
  geom_point(alpha = 0.3, size = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = FALSE, color = "blue") +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Conditional Residuals") +
  theme_minimal()
```
