---
title: "Beyond MLR - Week 2: Experimental Design II"
subtitle: "Two-way factorial ANOVA, replicated randomized block designs, and crossed random-effects models"
author: "Dr. Douwe Postmus"
format:
  revealjs:
    theme: [default, custom-reveal.scss]
    slide-number: true
    toc: false
    slide-level: 2
    incremental: false
    code-overflow: wrap
    scrollable: true
    smaller: true
    width: 1280
    height: 720
    margin: 0.06
    max-scale: 2
    footer: "Beyond multiple linear regression - week 2"
    logo: UMCG-logo.png
execute:
  warning: false
  message: false
  eval: true
  echo: false
---

```{r}
#| include: false
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(knitr, rmarkdown, dplyr, ggplot2, emmeans, lme4, lmerTest, broom.mixed)
```

## What did we learn last week

::: {style="font-size:88%"}
- Dummy and effects coding are two schemes for incorporating nominal variables (unordered factors in R) into linear regression models
  - The interpretation of coefficients depends on the coding scheme
    - Effects coding: coefficients represent deviations from the overall mean
    - Dummy coding: coefficients represent differences from the reference category
  - Estimated marginal means and ANOVA tests for the overall treatment effect are invariant to the coding scheme
- In randomized block designs, blocks (e.g., cages) define a shared environment for all experimental units (e.g., rats) within that block
  - Observations within the same block are positively correlated if the blocking variable is not included as a fixed effect
  - In such cases, the power to detect a treatment effect can be increased by including block as a random effect, which
  decomposes the unexplained variation (i.e., variation not explained by the fixed effects) into:
    - Variation between blocks (due to shared conditions)
    - Residual variation between individual units within blocks
  - The magnitude of the power gain depends on the degree of within-block correlation, quantified by the intraclass correlation coefficient (ICC)   
:::

## Today's lecture

- Designs with two experimental factors
  - Two-way factorial ANOVA
  - Main effects versus simple effects
- Designs wih nested and crossed random effects
  - Replicated randomized block designs
  - Crossed random-effects models  
  
# Part 1: Designs with two experimental factors

## First example: weight loss experiment

```{r}
set.seed(451)
Exercise <- factor(rep(c("Low", "Moderate", "High"), each = 20), levels=c("Low", "Moderate", "High"))
Diet <- factor(rep(rep(c("Standard", "High-protein"), each = 10), 3), levels = c("Standard", "High-protein"))
# Simulate additive (no interaction) pattern with negative means
mu <- expand.grid(Exercise = levels(Exercise), Diet = levels(Diet))
mu$mean <- rnorm(6, mean=2*c(-1.5, -2.0, -2.8, -3.3, -4.0, -4.5), sd=0.4)
y <- rnorm(60, mean = rep(mu$mean, each = 10), sd = 1)
df_weight <- data.frame(Exercise, Diet, DeltaWeight = y)
```

- Research question:
  - Does the combination of exercise intensity and diet type influence weight loss after 24 weeks?
- Study design:
  - 60 participants randomized evenly across six treatment combinations  
  - Factor A: exercise intensity (low, moderate, high)  
  - Factor B: diet type (standard, high-protein)  
  - Outcome: change in body weight from baseline to week 24 (kg; negative values indicate a reduction in weight)

## Exploratory data analysis

```{r}
ggplot(df_weight, aes(x = Exercise, y = DeltaWeight, color = Diet, group = Diet)) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun = mean, geom = "line") +
  ylab("Mean change in body weight (kg)") +  
  theme_minimal()
```

## Statistical model specification

To compare the mean change in body weight across exercise intensity and diet type we use the two-way factorial ANOVA model:

$$
Y_{ijk} = \mu + \alpha_i + \beta_j + (\alpha\beta)_{ij} + \varepsilon_{ijk}
$$

- Model components
  - $Y_{ijk}$: change in body weight for subject $k$ in exercise level $i$ and diet level $j$
  - $\mu$: grand mean across all groups
  - $\alpha_i$: deviation for exercise level $i$ with $\sum_i \alpha_i = 0$
  - $\beta_j$: deviation for diet level $j$ with $\sum_j \beta_j = 0$
  - $(\alpha\beta)_{ij}$: interaction between exercise and diet with $\sum_i (\alpha\beta)_{ij} = \sum_j (\alpha\beta)_{ij} = 0$
  - $\varepsilon_{ijk}$: residual error
- Statistical assumptions
  - $\varepsilon_{ijk} \sim \mathcal{N}(0,\sigma^2)$: errors are independent and identically normally distributed
  
## Group means in a two-way factorial ANOVA

- Each group mean can be expressed as a combination of the grand mean, main effects, and interaction effect:

| Exercise × Diet | Standard diet | High-protein diet | Row mean |
|------------------|----------------|------------------|-----------|
| Low | $\mu + \alpha_1 + \beta_1 + (\alpha\beta)_{11}$ | $\mu + \alpha_1 + \beta_2 + (\alpha\beta)_{12}$ | $\mu + \alpha_1$ |
| Moderate | $\mu + \alpha_2 + \beta_1 + (\alpha\beta)_{21}$ | $\mu + \alpha_2 + \beta_2 + (\alpha\beta)_{22}$ | $\mu + \alpha_2$ |
| High | $\mu + \alpha_3 + \beta_1 + (\alpha\beta)_{31}$ | $\mu + \alpha_3 + \beta_2 + (\alpha\beta)_{32}$ | $\mu + \alpha_3$ |
| Column mean | $\mu + \beta_1$ | $\mu + \beta_2$ | Grand mean = $\mu$ |

::: {style="margin-top:1.0em;"}
:::

- Effects coding with sum-to-zero constraints enables natural interpretation:
  - $\mu$ represents the overall average across all groups
  - $\alpha_i$ represents the deviation of exercise level $i$ from the grand mean
  - $\beta_j$ represents the deviation of diet level $j$ from the grand mean
  - $(\alpha\beta)_{ij}$ represents the deviation from additivity for the combination of exercise and diet

## 'Recipe' for two-way factorial ANOVA

1. Fit the two-way factorial ANOVA (using the `lm()` function in R)
2. Test the interaction effect
    - If the interaction effect is significant
      - Examine **simple effects**: the effect of one factor within each level of the other factor
      - Estimate and test conditional means, applying a Bonferroni adjustment for pairwise contrasts within levels
    - If the interaction effect is not significant
      - Examine **main effects**: the average effect of each factor across all levels of the other factor
      - Estimate and test marginal means, and for any significant factor with more than two levels, perform Bonferroni-adjusted pairwise comparisons

## ANOVA table and global hypothesis tests

```{r}
#| echo: false
options(contrasts = c("contr.sum", "contr.poly"))  # Effects coding
fit <- lm(DeltaWeight ~ Exercise * Diet, data = df_weight)
```
:::: {.columns style="font-size:90%"}

::: {.column width="50%"}

**Global hypotheses**

- No interaction $H_0\!:\,(\alpha\beta)_{ij}=0$ for all $i,j$
- No main effect of exercise $H_0\!:\,\alpha_i=0$ for all $i$
- No main effect of diet $H_0\!:\,\beta_j=0$ for all $j$

:::

::: {.column width="50%"}

**ANOVA table**
```{r}
#| echo: false
kable(
  tidy(anova(fit)),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 80%; margin-left: 0; margin-right: auto"'
)
```
:::

::::

::: {style="margin-top:1.0em;"}
:::

- The interaction effect is not significant (p = 0.116), so we proceed with interpreting the main effects
- The main effect of exercise is significant, indicating differences among the marginal means (row means) across low, moderate, and high exercise levels
  - Pairwise comparisons identify which excercise levels differ
- The main effect of diet is also significant, indicating a difference between the marginal means (column means) of standard and high-protein diet
  - Because this factor has only two levels, pairwise comparisons are not needed

## Analysis of the estimated marginal means

- Since the interaction effect is not significant, we examine the marginal means (average effects) for each factor:

```{r}
#| echo: true
# Main effects: marginal means across all levels of the other factor
emm_ex  <- emmeans(fit, ~ Exercise)
emm_diet <- emmeans(fit, ~ Diet)
```

Estimated marginal means:

:::: {.columns style="font-size:90%"}

::: {.column width="50%"}

```{r}
kable(data.frame(emm_ex),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 80%; margin-left: 0; margin-right: auto"'
)
```

:::

::: {.column width="50%"}

```{r}
kable(data.frame(emm_diet),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 80%; margin-left: 0; margin-right: auto"'
)
```

:::

::::

::: {style="margin-top:1.0em;"}
:::

Pairwise comparisons (with Bonferroni adjusted p-values):

```{r}
pairs_ex <- pairs(emm_ex, adjust = "bonferroni")
kable(
  broom::tidy(pairs_ex),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 80%; margin-left: 0; margin-right: auto"'
)
```

## Model diagnostics

- To assess the adequacy of the fitted model, we create the following two diagnostic plots:
  - **Normal Q-Q Plot**: to assess normality of the errors
  - **Residuals vs Fitted Plot**: to assess homoscedasticity (constant variance) for the errors

:::: {.columns}

::: {.column width="50%"}
```{r}
# Normal Q-Q
plot(fit, which = 2, main = "Normal Q-Q")
```
:::

::: {.column width="50%"}
```{r}
# Residuals vs Fitted
plot(fit, which = 1, main = "Residuals vs Fitted")
```
:::

::::

## Writing up the results - worked example

A two-way factorial ANOVA showed no significant interaction between exercise intensity and diet type, F(2, 54) = 2.21, p = 0. 116. There were significant main effects of both exercise intensity and diet type on the change in body weight. For exercise intensity, the estimated marginal means (95% CI) were −8.40 (−8.84, −7.96) kg for high intensity exercise, −5.51 (−5.95, −5.06) kg for moderate intensity exercise, and −3.35 (−3.79, −2.90) kg for low intensity exercise. Bonferroni-adjusted pairwise comparisons indicated that all exercise levels differed significantly from one another (p < 0.001 for all comparisons). For diet type, the estimated marginal means (95% CI) were −6.54 (−6.90, −6.17) kg for the high-protein diet and −4.97 (−5.33, −4.60) kg for the standard diet.  

## Second example: dental filling experiment

```{r}
set.seed(789)
Composite <- factor(rep(c("Hybrid", "Microfine", "Microhybrid"), each = 20), levels = c("Hybrid", "Microfine", "Microhybrid"))
CuringTime <- factor(rep(rep(c("20s", "60s"), each = 10), 3), levels = c("20s", "60s"))

# Generate hardness data with specified effects
# Hybrid: 20s mean ~47.5, 60s mean ~52.5 (difference of 5)
# Microfine: both ~50 (no effect of curing time)
# Microhybrid: both ~50 (no effect of curing time)
mu <- expand.grid(Composite = levels(Composite), CuringTime = levels(CuringTime))
mu$mean <- c(47.5, 52.5, 50, 50, 50, 50)
hardness <- rnorm(60, mean = rep(mu$mean, each = 10), sd = 1.5)

df_dental <- data.frame(Composite, CuringTime, Hardness = hardness)
```

- Research question:
  - Does the combination of composite type and curing time influence the hardness of dental fillings?
- Study design:
  - 60 specimens randomly assigned to six treatment combinations (n = 10 each)
  - Factor A: composite type (hybrid, microfine, microhybrid)
  - Factor B: curing time (20s, 60s)
  - Response variable: Hardness (measured in Knoop hardness; higher scores indicate greater hardness)

## Exploratory data analysis

```{r}
ggplot(df_dental, aes(x = Composite, y = Hardness, color = CuringTime, group = CuringTime)) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun = mean, geom = "line") +
  ylab("Mean hardness (Knoop hardness)") +  
  theme_minimal()
```

## ANOVA table and global hypothesis tests

```{r}
#| echo: false
options(contrasts = c("contr.sum", "contr.poly"))  # Effects coding
fit_dental <- lm(Hardness ~ Composite * CuringTime, data = df_dental)
```
:::: {.columns style="font-size:90%"}

::: {.column width="50%"}

**Global hypotheses**

- No interaction $H_0\!:\,(\alpha\beta)_{ij}=0$ for all $i,j$
- No main effect of composite $H_0\!:\,\alpha_i=0$ for all $i$
- No main effect of curing time $H_0\!:\,\beta_j=0$ for all $j$

:::

::: {.column width="50%"}

**ANOVA table**
```{r}
#| echo: false
kable(
  tidy(anova(fit_dental)),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 80%; margin-left: 0; margin-right: auto"'
)
```
:::

::::

::: {style="margin-top:1.0em;"}
:::

- The interaction effect is significant (p < 0.05), indicating that the effect of curing time on hardness depends on the composite type
- The main effects tests still have meaning: they test whether the average effect of each factor differs from zero, pooled across all levels of the other factor
- Simple effects analysis is more informative when an interaction is present, examining how one factor affects the response within each level of the other factor

## Simple effects analysis

- For each composite type, we examine whether curing time (20s vs 60s) affects hardness:

```{r}
#| echo: true
# Simple effects: curing time within each composite type
se_composite <- emmeans(fit_dental, ~ CuringTime | Composite)
se_pairs <- pairs(se_composite, adjust = "bonferroni")
```

:::: {.columns style="font-size:90%"}

::: {.column width="50%"}

Estimated means by composite type and curing time:

```{r}
#| echo: false
kable(
  data.frame(se_composite),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 75%; margin-left: 0; margin-right: auto"'
)
```

:::

::: {.column width="50%"}

Pairwise comparisons (20s vs 60s within each composite):

```{r}
#| echo: false
kable(
  broom::tidy(se_pairs)[, c("Composite", "term", "contrast", "estimate", "std.error", "p.value")],
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 75%; margin-left: 0; margin-right: auto"'
)
```

:::

::::

::: {style="margin-top:1.0em;"}
:::

- The effect of curing time is significant only for the hybrid composite (p < 0.05), where longer curing (60s) produces higher hardness
- Curing time has no significant effect on hardness for microfine and microhybrid composites

## Model diagnostics

- To assess the adequacy of the fitted model, we again create the following two diagnostic plots:
  - **Normal Q-Q Plot**: to assess normality of the errors
  - **Residuals vs Fitted Plot**: to assess homoscedasticity (constant variance) for the errors

:::: {.columns}

::: {.column width="50%"}
```{r}
# Normal Q-Q
plot(fit, which = 2, main = "Normal Q-Q")
```
:::

::: {.column width="50%"}
```{r}
# Residuals vs Fitted
plot(fit, which = 1, main = "Residuals vs Fitted")
```
:::

::::

## Writing up the results - worked example

A two-way factorial ANOVA revealed a significant interaction between composite type and curing time, F(2, 54) = 26.72, p < 0.001. Given the significant interaction, a simple effects analysis was performed to examine the effect of curing time within each composite type. For hybrid composite, hardness was significantly higher with 60-second curing (52.1, 95% CI: 51.2–53.0) compared to 20-second curing (47.0, 95% CI: 46.1–47.8), with a difference of 5.13 units (p < 0.001). For microfine composite, there was no significant difference between 20-second curing (49.7, 95% CI: 48.8–50.5) and 60-second curing (49.5, 95% CI: 48.6–50.3), p = 0.739. Similarly, for microhybrid composite, curing time had no significant effect, with means of 50.7 (95% CI: 49.9–51.6) for 20-second curing and 50.3 (95% CI: 49.4–51.1) for 60-second curing, p = 0.460. These results indicate that the benefit of extended curing time is material-specific, applying only to the hybrid composite.

## Summary

- Two-way factorial ANOVA can be used to test the effects of two experimental factors and their interaction:
  - When the interaction is not significant, examine main effects via marginal means
  - When the interaction is significant, simple effects analysis is more informative—examining how one factor affects the response within each level of the other
- Key distinction:
  - Main effects: average effect of one factor across all levels of the other factor
  - Simple effects: effect of one factor within a specific level of the other factor
  - Interaction indicates that simple effects differ from main effects
- Effects coding with sum-to-zero constraints enables natural interpretation:
  - Grand mean represents the overall average
  - Main effect coefficients represent deviations from the grand mean
  - Interaction coefficients represent deviations from additivity

## Lab 3: Two-way factorial ANOVA with two experimental factors

![](/R-lab.png){width="60%"  fig-align="center" alt="Lab session"}

# Part 2: Designs wih nested and crossed random effects

## Hierarchical versus crossed data structures

- Grouped data arise when observational units share common conditions defined by one or more context variables
- In a randomized block design, observational units are grouped into blocks defined by levels of a context variable, creating a two-level hierarchical structure 
- A replicated randomized block design extends this to a three-level hierarchy, with individual observations nested within treatment–block combinations, which are nested within blocks
- When observations are influenced by two (or more) context variables, different types of grouping structures may arise
  - Hierarchical: one context variable is nested within the other
    - Example: pupils nested in classes and classes nested in schools
  - Crossed: lower-level units are simultaneously nested within two separate, non-nested hierarchies
    - Example: grades cross-classified by student and evaluator
- Crossed and hierarchical structures can be combined, for example when observations are nested within specific combinations of crossed factors such as student–evaluator pairs    

## Interactions between fixed and random effects

- Two-way factorial ANOVA with two experimental factors:
  - Explored the interaction between two fixed effects
  - The interaction itself was of substantive interest, testing whether the effect of one factor depends on the level of the other
- Randomized block design (last week):
  - Included a fixed treatment effect and a random cage effect
  - The random effect accounts for block-to-block variability, which is not of substantive interest
- Replicated randomized block design: 
  - Extends the basic design by adding replicates within each block, allowing estimation of a treatment–block (fixed–random) interaction
  - Including it makes the model more robust by acknowledging block-level heterogeneity, though this typically leads to more conservative inference for the treatment effect

## Lab 4: replicated randomized block designs

![](/R-lab.png){width="60%"  fig-align="center" alt="Lab session"}

## Example: radiologist measurements of tumor size

```{r}
set.seed(123)

n_patients <- 10
n_radiologists <- 5
sigma_patient <- 3
sigma_radiologist <- 2
sigma_resid <- 1

data.tomour <- expand.grid(patient = 1:n_patients, radiologist = 1:n_radiologists) |>
  mutate(
    patient_eff = rnorm(n_patients)[patient] * sigma_patient,
    radiologist_eff = rnorm(n_radiologists)[radiologist] * sigma_radiologist,
    measurement = 50 + patient_eff + radiologist_eff + rnorm(n(), 0, sigma_resid)
  )

data.tomour <- data.tomour |>
  mutate(
    patient = factor(patient),
    radiologist = factor(radiologist)
  )

```

- Research question: 
  - To what extent do radiologists give the same results when measuring the same tumors?
- Study design:
  - CT scans from 10 patients were independently assessed by 5 radiologists
  - Each radiologist measured the maximum tumor diameter (mm) on every scan

## Exploratory data analysis

```{r}
# Interaction plot: measurement by radiologist for each patient
ggplot(data.tomour, aes(x = radiologist, y = measurement, group = patient, colour = patient)) +
  geom_line(alpha = 0.8) +
  geom_point(size = 1.5, alpha = 0.9) +
  stat_summary(aes(group = 1), fun = mean, geom = "point", shape = 21, fill = "black", colour = "white", size = 3, stroke = 1.2) +
  stat_summary(aes(group = 1), fun = mean, geom = "line", colour = "black", size = 1, linetype = "dashed") +
  labs(title = NULL,
       x = "Radiologist",
       y = "Measurement (mm)",
       colour = "Patient") +
  theme_minimal() +
  theme(legend.position = "right")
```

## How to model these data

- We want to assess to what extent radiologists give the same results when measuring the same tumors
- Measurements vary for three main reasons:
  - True differences between patients (biological variation in tumor size)
  - Systematic differences between radiologists (some may measure consistently higher or lower)
  - Unexplained measurement error
- To separate these sources of variability, we use a **crossed random-effects model**
  - Both patients and radiologists are treated as random samples from larger populations
  - Random intercepts are included for each, as they are not hierarchically nested

## Statistical model specification

$$Y_{ij} = \mu + u_i + v_j + \varepsilon_{ij}$$

- $Y_{ij}$: measured tumor size for patient *i* assessed by radiologist *j*  
- $\mu$: overall mean tumor size across all patients and radiologists  
- $u_i \sim N(0, \sigma^2_{\text{patient}})$: random effect for patient, representing true biological differences in tumor size  
- $v_j \sim N(0, \sigma^2_{\text{radiologist}})$: random effect for radiologist, representing systematic measurement differences between radiologists  
- $\varepsilon_{ij} \sim N(0, \sigma^2)$: residual error term capturing unexplained measurement error


::: {.callout-note icon=false title="R code snippet"}
```{r}
#| echo: true
#| eval: false
model_crossed <- lmer(measurement ~ (1 | radiologist) + (1 | patient), data = data.tomour)
```
:::

## Quantifying agreement and consistency

:::: {.columns style="font-size:90%"}

::: {.column width="50%"}

**Agreement**

- Measures the extent to which radiologists give the same numerical results when assessing the same patients  
- Defined as the proportion of total variance explained by true patient differences  
  $$
  ICC_{\text{agreement}} =
  \frac{\sigma^2_{\text{patient}}}
       {\sigma^2_{\text{patient}} + \sigma^2_{\text{radiologist}} + \sigma^2}
  $$

- High values indicate that most of the variation reflects real biological differences rather than who performed the measurement

:::

::: {.column width="50%"}

**Consistency**

- Measures the extent to which radiologists give measurements that rank patients in the same order
- Defined as the proportion of variance explained by true patient differences, excluding radiologist-level variability  
  $$
  ICC_{\text{consistency}} =
  \frac{\sigma^2_{\text{patient}}}
       {\sigma^2_{\text{patient}} + \sigma^2}
  $$

- High values indicate that radiologists are consistent in ranking patients, even if their absolute measurements are on different scales

:::

::::

- In this context, agreement is the more logical measure because treatment planning depends on the absolute tumor size values, not just on how patients rank relative to one another  


## Results and interpretation

```{r}
model_crossed <- lmer(measurement ~ (1 | radiologist) + (1 | patient), data = data.tomour)
``` 

:::: {.columns}

::: {.column width="50%"}

**Estimated fixed effects**

```{r}
fe <- tidy(model_crossed, effects = "fixed")[, c("term","estimate","std.error","p.value")]

kable(
  fe,
  digits = 3,
  caption = NULL,
  format = "html",
  table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"'
)
```

:::

::: {.column width="50%"}

**Estimated variance components**

```{r}
re <- tidy(model_crossed, effects = "ran_pars")[, c("group", "term", "estimate")]

kable(
  re,
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"'
)
```

:::

::::

- The overall mean tumor size is about 50.8 mm, averaged across all patients and radiologists 

**Agreement**

$ICC_{\text{agreement}} =
\frac{\sigma^2_{\text{patient}}}
     {\sigma^2_{\text{patient}} + \sigma^2_{\text{radiologist}} + \sigma^2} =
\frac{2.73^2}{2.73^2 + 1.21^2 + 1.00^2} = 0.74$    

- About 74% of the total variability in measured tumor size reflects true differences between patients
- The remaining 26% is due to radiologist differences and measurement noise
- This indicates fairly high agreement among radiologists: measurements largely reflect real biological variation rather than who performed them
