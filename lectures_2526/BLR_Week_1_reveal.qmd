---
title: "Beyond MLR - Week 1: Experimental Design I"
subtitle: "One-way ANOVA, stratified randomization, and randomized block designs"
author: "Dr. Douwe Postmus"
format:
  revealjs:
    theme: [default, custom-reveal.scss]
    slide-number: true
    toc: false
    slide-level: 2
    incremental: false
    code-overflow: wrap
    scrollable: true
    smaller: true
    width: 1280
    height: 720
    margin: 0.06
    max-scale: 2
    footer: "Beyond linear regression - week 1"
    logo: UMCG-logo.png
execute:
  warning: false
  message: false
  eval: true
  echo: false
---

```{r}
#| include: false
#| message: false
#| warning: false
options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(knitr, rmarkdown, dplyr, ggplot2, emmeans, lme4, lmerTest, mixed, broom.mixed)
```

## Introduction

- Welcome slide (to be completed later)

## Case study — antihypertensive treatments

- Design: 120 patients with hypertension are randomly assigned to one of three groups (n = 40 each): Control, Drug A, or Drug B
- Response (outcome): change in SBP (mmHg) from baseline to week 52

```{r}
#| echo: false
set.seed(123)
control <- rnorm(40, mean = -3,  sd = 15)
drugA   <- rnorm(40, mean = -10, sd = 15)
drugB   <- rnorm(40, mean = -5,  sd = 15)
df_bp <- data.frame(
  Treatment = factor(rep(c("Control","DrugA","DrugB"), each = 40),
                     levels = c("Control","DrugA","DrugB")),
  SBP_change = c(control, drugA, drugB)
)
contrasts(df_bp$Treatment) <- contr.sum(3) # Change coding to effects coding
```

```{r}
#| echo: false
boxplot(SBP_change ~ Treatment, data = df_bp,
        col = c("gray85","skyblue","lightgreen"),
        ylab = "Change in SBP (mmHg)", main = NULL)
```

## Statistical model specification

To compare the mean change in SBP across the three treatment groups, we use the one-way ANOVA model:

$$
Y_{ij} = \mu + \tau_i + \varepsilon_{ij}
$$

- Model components:
  - $Y_{ij}$: change in SBP for the $j$-th subject in the $i$-th treatment group
  - $\mu$ (grand mean): the overall mean across groups (the average of the group means)
  - $\tau_i$ (treatment deviations): the deviation of the mean of group $i$ from the grand mean; constrained so $\sum_i \tau_i = 0$
  - $\varepsilon_{ij}$ (residual error): the deviation for subject $j$ from the mean of group $i$
- Statistical assumptions:
  - $\varepsilon_{ij}\sim\mathcal{N}(0,\sigma^2)$: errors are independent and identically normally distributed with mean zero and common variance $\sigma^2$ (homoscedasticity)

## Estimation using linear regression

- A one-way ANOVA model can be expressed as a linear regression with a categorical predictor, allowing us to use the regression framework for estimation and hypothesis testing
- Using *effects coding* with Drug B as the implied category under the sum-to-zero constraint, the statistically equivalent regression model is:

:::: {.columns}

::: {.column width="50%"}
$$
Y_{ij} = \beta_0 + \beta_1 \text{Treatment1}_{ij} + \beta_2 \text{Treatment2}_{ij} + \varepsilon_{ij}
$$
:::

::: {.column width="50%"}

<div style="font-size: 75%;">

| Treatment | Intercept | Treatment1 | Treatment2 |
|---|---:|:---:|:---:|
| Control | 1 | 1 | 0 |
| DrugA   | 1 | 0 | 1 |
| DrugB   | 1 | -1 | -1 |

</div>

:::

::::

```{=html}
<div style="margin-top:1.5em;"></div>
```

:::: {.columns  style="font-size:70%"}

::: {.column width="50%"}

**Estimated regression coefficients:**
```{r}
#| echo: false
fit <- lm(SBP_change ~ Treatment, data = df_bp)
kable(tidy(fit)[, c("term","estimate","std.error","p.value")], digits = 3, format = "html", table.attr = 'style="font-size: 90%; margin-left: 0; margin-right: auto"')
```

:::

::: {.column width="50%"}

**Mapping to the ANOVA model parameters:**

- Grand mean:
  $\mu = \beta_0$

- Treatment deviations:
  - $\tau_{\text{Control}} = \beta_1$
  - $\tau_{\text{DrugA}}   = \beta_2$
  - $\tau_{\text{DrugB}}   = -(\tau_{\text{Control}} + \tau_{\text{DrugA}}) = -(\beta_1 + \beta_2)$

:::

::::

## Estimated marginal means (EMMs)

- ANOVA parameters describe group deviations from the grand mean
- Estimated marginal means (EMMs) express the same model in terms of predicted group means
- In a one-way ANOVA model, the EMMs equal the observed group means
- In more complex models, EMMs give adjusted or conditional means that make comparisons fairer
  - With covariates (ANCOVA): EMMs adjust group means to a common covariate value, such as the overall mean
  - With interactions: EMMs provide conditional means for specific combinations of factors, allowing group comparisons at chosen settings

```{r}
#| echo: false
# Compute and display estimated marginal means
emms <- emmeans(fit, ~ Treatment)
summary(emms)
```

## ANOVA table
:::: {.columns}

::: {.column width="50%" style="font-size:85%"}
**Sum of squares decomposition**

$SS_{Total} = SS_{Treatment} + SS_{Residual}$

- $SS_{Total}$: total variation around the grand mean
  $$SS_{Total} = \sum_{i=1}^g\sum_{j=1}^{n_i} (Y_{ij} - \bar{Y}_{..})^2$$

- $SS_{Treatment}$: between-group variation
  $$SS_{Treatment} = \sum_{i=1}^g n_i(\bar{Y}_{i.} - \bar{Y}_{..})^2$$

- $SS_{Residual}$: within-group variation
  $$SS_{Residual} = \sum_{i=1}^g\sum_{j=1}^{n_i} (Y_{ij} - \bar{Y}_{i.})^2$$
:::

::: {.column width="50%" style="font-size:85%"}

**Degrees of freedom**

- $df_{Treatment}=g-1$
- $df_{Residual}=N-g$

 **Mean squares**

- $MS_{Treatment}=SS_{Treatment}/(g-1)$
- $MS_{Residual}=SS_{Residual}/(N-g)$

**ANOVA table**

```{r}
kable(
  tidy(anova(fit)),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 100%; margin-left: 0; margin-right: auto"'
)
```

:::

::::

## Global hypothesis test (F-test)

```{r}
kable(
  tidy(anova(fit)),
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 100%; margin-left: 0; margin-right: auto"'
)
```

```{=html}
<div style="margin-top:1em;"></div>
```

- Hypotheses
  - $H_0$: all group means or equal ($\tau_{Control} = \tau_{DrugA} = \tau_{DrugB} = 0$)
  - $H_1$: at least one group mean is different
- Test statistic:
  $F = \frac{MS_{Treatment}}{MS_{Residual}}$
  - Under $H_0$, this follows an $F_{g-1,\,N-g}$ distribution (with $g$ groups and $N$ observations)
  - A large $F$ indicates treatment explains appreciable between-group variation
  - In our example, the p-value is $\leq 0.05$, so we reject $H_0$ and conclude that the treatment has a significant effect on the change in SBP

## Post-hoc comparisons

- Since we found a significant effect of treatment, we will conduct pairwise comparisons of the estimated group means to identify which specific treatment groups differ significantly from one another
- To account for the increased Type I error risk due to multiple comparisons, we apply the Bonferroni correction to adjust the p-values, ensuring that the overall significance level remains controlled

```{r}
# Performing post-hoc analysis with emmeans
emms <- emmeans(fit, ~ Treatment)
contrast(emms, method="pairwise", adjust="Bonferroni")
```

## Model diagnostics

- To assess the adequacy of the fitted model, we create two diagnostic plots:
  - **Normal Q-Q Plot**: Used to assess normality of the errors
  - **Residuals vs Fitted Plot**: Used to assess homoscedasticity (constant variance) for the errors

:::: {.columns}

::: {.column width="50%"}
```{r}
# Normal Q-Q
plot(fit, which = 2, main = "Normal Q-Q")
```
:::

::: {.column width="50%"}
```{r}
# Residuals vs Fitted
plot(fit, which = 1, main = "Residuals vs Fitted")
```
:::

::::

# Part II

## Nuisance variables

- Nuisance variables are variables that influence the response but are not of primary interest
- Examples include age, baseline blood pressure, comorbidity, or study center
- If not controlled, they can
  - increase random variation → more noise, less precision
  - introduce systematic differences between treatment groups → biased estimates of treatment effects
- Randomization helps balance nuisance variables across treatments on average
- Additional control can be achieved through blocking or covariate adjustment to separate their influence from the treatment effect

## Reducing residual variation: blocking

- Design stage
  - Group experimental units that are similar on a known nuisance variable (e.g., study center, sex, baseline severity)
  - Randomize treatments within each block to avoid bias and ensure balance across levels of the nuisance variable  (this is known as an orthogonal design)

- Analysis stage
  - Include the block term in the statistical model (two-way ANOVA)

  $$Y_{ijk} = \mu + \tau_i + \beta_j + \varepsilon_{ijk}$$

  - This analysis separates block effects ($\beta_j$) from the residual error and therefore allows treatment effects to be estimated with increased precision

## First example: stratified randomization

- Study population: 135 patients with baseline SBP ≥140 mmHg, classified into three hypertension grades
  - Grade 1: 140–159 mmHg
  - Grade 2: 160–179 mmHg
  - Grade 3: ≥180 mmHg
- Randomization: performed separately within each grade to ensure that all treatments are represented equally across hypertension categories
- Treatments: Control, Drug A, Drug B (n = 45 per group; 15 per grade)
- Outcome: change in SBP (mmHg) from baseline to week 52

```{r}
set.seed(431)

# design
trt_levels  <- c("Control","DrugA","DrugB")
grades      <- c("Grade1","Grade2","Grade3")              # SBP-only grading
n_per_trt   <- 45                                          # divisible by 3 grades
n_per_cell  <- n_per_trt / length(grades)
sd_eps      <- 8

# treatment means (overall), mmHg change over 12 weeks (plausible magnitudes)
trt_mean <- c(Control = -4, DrugA = -11, DrugB = -8)

# strong baseline grade effect on change (higher baseline → larger drop)
grade_effect <- c(Grade1 = 0, Grade2 = -6, Grade3 = -12)

# helper to simulate baseline SBP within each grade
r_sbp <- function(grade, n) {
  if (grade == "Grade1") rnorm(n, mean = 148, sd = 6)     # 140–159
  else if (grade == "Grade2") rnorm(n, mean = 168, sd = 6) # 160–179
  else rnorm(n, mean = 185, sd = 7)                        # ≥180
}

# build stratified dataset: equal n per grade × treatment
df_bp_strat <- do.call(
  rbind,
  lapply(grades, function(g) {
    do.call(
      rbind,
      lapply(trt_levels, function(t) {
        mu <- trt_mean[[t]] + grade_effect[[g]]
        n  <- n_per_cell
        data.frame(
          HypertensionGrade = g,
          Treatment = t,
          Baseline_SBP = r_sbp(g, n),
          SBP_change  = rnorm(n, mean = mu, sd = sd_eps)
        )
      })
    )
  })
)

df_bp_strat$HypertensionGrade <- factor(df_bp_strat$HypertensionGrade, levels = grades)
df_bp_strat$Treatment <- factor(df_bp_strat$Treatment, levels = trt_levels)
contrasts(df_bp_strat$Treatment) <- contr.sum(3)
contrasts(df_bp_strat$HypertensionGrade) <- contr.sum(3)
```

## Exploratory data analysis

```{r}
eda_sum <- df_bp_strat %>%
  group_by(Treatment, HypertensionGrade) %>%
  summarise(
    n    = n(),
    mean = mean(SBP_change),
    sd   = sd(SBP_change),
    se   = sd / sqrt(n),
    tcrt = qt(0.975, df = n - 1),
    ci   = tcrt * se,
    .groups = "drop"
  )

ggplot(eda_sum, aes(x = Treatment, y = mean,
                    group = HypertensionGrade,
                    color = HypertensionGrade, shape = HypertensionGrade)) +
  geom_line() +
  geom_point(size = 3) +
  #geom_errorbar(aes(ymin = mean - ci, ymax = mean + ci), width = 0.12) +
  labs(
    x = "Treatment",
    y = "Mean change in SBP (mmHg)",
    title = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

## Results

:::: {.columns}

::: {.column width="50%"}

**One-way ANOVA (ignoring hypertension grade)**

```{r}
fit_oneway <- lm(SBP_change ~ Treatment, data = df_bp_strat)
kable(tidy(anova(fit_oneway)), digits = 3, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::: {.column width="50%"}

**Two-way ANOVA (additive model)**

```{r}
fit_adj <- lm(SBP_change ~ Treatment + HypertensionGrade, data = df_bp_strat)
kable(tidy(anova(fit_adj)), digits = 3, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::::

- Effect of blocking / stratification:
  - When hypertension grade is ignored, its effect is absorbed into the residual error term
  - Including hypertension grade as an additional factor partitions out that systematic variation into a separate term
  - This typically reduces $MS_{Residual}$ while leaving $MS_{Treatment}$ approximately the same in balanced designs
  - As a result, the F statistic for treatment tends to increase, meaning the test gains power to detect treatment differences

## Second example: randomized block design

```{r}
set.seed(329)  # For reproducibility

# Increase between-cage variability
between_cage_sd <- 2  # Standard deviation for the cage effect

# Cage effect (one random effect per cage)
cage_effect <- rnorm(8, mean = 0, sd = between_cage_sd)

# Simulate data with larger cage effect
data <- data.frame(
  Cage = rep(1:8, times = 3),
  Treatment = rep(c("Placebo", "20 mg", "50 mg"), each = 8),
  Weight_Change = c(rnorm(8, mean = 14 + cage_effect, sd = 2),
                    rnorm(8, mean = 13 + cage_effect, sd = 2),
                    rnorm(8, mean = 11 + cage_effect, sd = 2))
)

data$Treatment <- factor(data$Treatment, levels=c("Placebo", "20 mg", "50 mg"))
data$Cage <- as.factor(data$Cage)
contrasts(data$Treatment) <- contr.sum(3)
contrasts(data$Cage) <- contr.sum(8)
```

- Objective: test the potential toxic effects of an experimental drug X by assessing changes in body weight in rats
- Study design:
  - Animals: 24 Sprague-Dawley rats
  - Groups:
    - Control Group: 8 rats receive a placebo
    - Drug X Group 1: 8 rats receive Drug X at 20 mg/kg/day
    - Drug X Group 2: 8 rats receive Drug X at 50 mg/kg/day
- Blocking by cage placement: randomization of treatments within each cage to control for variability due to environmental factors (e.g., light, temperature)

## Exploratory data analysis

```{r}
# Create the scatter plot
ggplot(data, aes(x = Weight_Change, y = factor(Cage), color = Treatment)) +
  geom_point(size = 4) +
  labs(title = NULL,
       x = "Weight Change (grams)",
       y = "Cage",
       color = "Treatment") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

## One-way ANOVA ignoring cage

```{r}
m1 <- lm(Weight_Change ~ Treatment, data = data)
```

:::: {.columns}

::: {.column width="50%"}

**Estimated regression coefficients**

```{r}
kable(tidy(m1)[, c("term","estimate","std.error","p.value")], digits = 3, caption = NULL, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::: {.column width="50%"}

**ANOVA table**

```{r}
kable(tidy(anova(m1)), digits = 3, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::::

```{=html}
<div style="margin-top:1.5em;"></div>
```

- Ignoring cage differences pushes cage-to-cage variability into the residual error term
- This inflates standard errors and reduces power compared with models that adjust for cages

## Incorporating the effect of cage

- Some cages show consistently higher or lower weights, suggesting an extra source of variation due to the cage environment
- Two options to include cage in the model
  - Treat cage as a fixed effect: adjust for these eight cages
    - Each level gets its own estimate
    - Inference applies only to these specific levels
    - Example: “How do rats in cage 1 compare to those in cage 2?”
  - Treat cage as a random effect: account for cage to cage variability
    - We are not interested in individual cages, but in their variability
    - Inference generalizes to the population of possible cages
    - Example: “How much do rat weights differ between cages on average?”


## Statistical model specification

:::: {.columns}

::: {.column width="50%"}

**Fixed-effects specification**

$$
Y_{ijk} = \mu + \tau_i + \beta_j + \varepsilon_{ijk}
$$

- Adds one separate parameter for each cage
- The model becomes more complex as more cages are added
- No estimate of how much cages differ on average

:::

::: {.column width="50%"}

**Random-effects specification**

$$
Y_{ijk} = \mu + \tau_i + b_j + \varepsilon_{ijk}, \quad b_j \sim N(0, \sigma_b^2)
$$

- $b_j$: random intercept describing how cage $j$ differs from the overall mean
- Estimates the average variability between cages ($\sigma_b^2$)
- Inference focuses on overall treatment effects while accounting for cage-to-cage variability

:::

::::

## Two-way ANOVA: cage as fixed effect

```{r}
m2 <- lm(Weight_Change ~ Treatment + Cage, data = data)
```

:::: {.columns}

::: {.column width="50%"}

**Estimated regression coefficients**

```{r}
kable(tidy(m2)[, c("term","estimate","std.error","p.value")], digits = 3, caption = NULL, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::: {.column width="50%"}

**ANOVA table**

```{r}
kable(tidy(anova(m2)), digits = 3, format = "html", table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"')
```
:::

::::

```{=html}
<div style="margin-top:1.5em;"></div>
```

- Adjusts for the eight cages as specific environments
- Inference applies only to these cages

## Two-way ANOVA: cage as random effect

```{r}
m3 <- lmer(Weight_Change ~ Treatment + (1 | Cage), data = data)
```

:::: {.columns}

::: {.column width="50%"}

**Estimated fixed effects**

```{r}
library(broom.mixed)
fe <- tidy(m3, effects = "fixed")[, c("term","estimate","std.error","p.value")]

knitr::kable(
  fe,
  digits = 3,
  caption = NULL,
  format = "html",
  table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"'
)
```

```{=html}
<div style="margin-top: 0.75em;"></div>
```

**Random-effects variance components**

```{r}
vc <- as.data.frame(VarCorr(m3))[, c("grp","vcov","sdcor")]
names(vc) <- c("component","variance","sd")

knitr::kable(
  vc,
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"'
)
```
:::

::: {.column width="50%"}

**ANOVA table**

```{r}
a_tbl <- broom::tidy(anova(m3))

knitr::kable(
  a_tbl,
  digits = 3,
  format = "html",
  table.attr = 'style="font-size: 70%; margin-left: 0; margin-right: auto"'
)
```

:::

::::

```{=html}
<div style="margin-top:1.5em;"></div>
```

- Treats cage as a random effect sampled from a population of possible cages
- Estimates treatment effects and between cage variance and generalizes beyond these cages

## Understanding variance components

- In the one-way ANOVA that ignored cage, all unexplained variation was captured by a single residual error term → this error combined both *between-cage* and *within-cage* differences

- In the two-way ANOVA with cage as a random effect, that residual variability is *partitioned* into two parts:
  1. Between-cage variance: how much average weight change differs between cages
  2. Within-cage (residual) variance: how much rats differ within the same cage after accounting for both treatment and cage effects

| component | variance | sd |
|------------|-----------|----|
| Cage | 3.507 | 1.873 |
| Residual | 3.124 | 1.768 |

- Together, these are the **variance components**: they describe how the total unexplained variability from the simpler model is partitioned into variation **between** and **within** cage

## Intra-class correlation (ICC)

- The intra-class correlation (ICC) quantifies the proportion of the total unexplained variability that is due to between-cage differences:

$$
ICC = \frac{\sigma^2_{\text{cage}}}{\sigma^2_{\text{cage}} + \sigma^2_{\text{residual}}}
     = \frac{3.507}{3.507 + 3.124} = 0.529
$$

- Here, ICC ≈ 0.53, meaning that about 53% of the remaining variation (after accounting for treatment) arises from differences between cages
- Interpretation:
  - High ICC: rats in the same cage tend to have more similar outcomes
  - Low ICC: cage membership adds little information beyond treatment

## Fixed or random effects for nuisance variables

- **Stratified randomization example:**
  - The stratification factor (hypertension grade) divides subjects into predefined categories used consistently across studies
  - The specific levels (grade 1, grade 2, grade 3) are fixed and always the same
  - The factor is modeled as a **fixed effect**, adjusting for systematic differences between these known categories

- **Randomized block design example:**
  - The blocking factor (cage) represents a random source of environmental variation
  - The cages themselves are not of intrinsic interest and could have been any comparable set
  - Modeling cage as a **random effect** captures this variability naturally and allows generalization beyond the observed cages
